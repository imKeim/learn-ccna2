<!-- 4.1.1 -->
## Что такое маршрутизация между VLAN?

VLAN используются для сегментации коммутируемых сетей уровня 2 по разным причинам. Независимо от причины, хосты в одной VLAN не могут взаимодействовать с хостами в другой VLAN, если нет маршрутизатора или коммутатора уровня 3 для предоставления услуг маршрутизации.

Маршрутизация между сетями VLAN — это процесс переадресации сетевого трафика из одной сети VLAN в другую с помощью маршрутизатора.

Существуют три варианта маршрутизации между VLAN.

* **Старый метод маршрутизации между VLAN** - это устаревшее решение. Плохо масштабируется
* **Router-on-a-Stick** - это приемлемое решение для сети малых и средних размеров.
* **Коммутатор уровня 3 с использованием коммутируемых виртуальных интерфейсов (SVI)** — это наиболее масштабируемое решение для средних и крупных организаций.

<!-- 4.1.2 -->
## Устаревшие методы маршрутизации между сетями VLAN

Первое решение маршрутизации между VLAN основывалось на использовании маршрутизатора с несколькими интерфейсами Ethernet. Каждый интерфейс маршрутизатора был подключен к порту коммутатора в разных VLAN. Интерфейсы маршрутизатора служат шлюзами по умолчанию для локальных узлов в подсети VLAN.

Например, посмотрите на топологию, где R1 имеет два интерфейса, подключенных к коммутатору S1.

![](./assets/4.1.2.svg)


Примечание в примере таблицы MAC-адресов S1 заполняется следующим образом:

* Порт Fa0/1 назначен VLAN 10 и подключен к интерфейсу R1 G0/0/0.
* Порт Fa0/11 назначен VLAN 10 и подключен к PC1.
* Порт Fa0/12 назначен VLAN 20 и подключен к интерфейсу R1 G0/0/1.
* Порт Fa0/11 назначается VLAN 20 и подключен к PC2.

**MAC Address table for S1**

| **Порт** | **MAC-адрес** | **VLAN** |
| --- | --- | --- |
| F0/1 | R1 G0/0/0 MAC | 10 |
| F0/11 | PC1 MAC | 10 |
| F0/12 | R1 G0/0/1 MAC | 20 |
| F0/24 | PC2 MAC | 20 |

Когда PC1 отправляет пакет PC2 в другой сети, он пересылает его на шлюз по умолчанию 192.168.10.1. R1 получает пакет через интерфейс G0/0/0 и проверяет адрес назначения пакета. Затем R1 направляет пакет из интерфейса G0/0/1 на порт F0/12 в VLAN 20 на S1. Наконец, S1 перенаправляет кадр на PC2.

Устаревший метод маршрутизации между VLAN, использующий физические интерфейсы, имеет большие ограничения. Он не является достаточно масштабируемым, поскольку маршрутизаторы имеют ограниченное количество физических интерфейсов. По мере возрастания количества VLAN в сети, требующих по одному физическому интерфейсу на каждую VLAN, количество свободных интерфейсов маршрутизатора быстро уменьшается.

В нашем примере R1 требуется два отдельных интерфейса Ethernet для маршрутизации между VLAN 10 и VLAN 20. Что делать, если было шесть (или более) VLAN для связи? Для каждой VLAN потребуется отдельный интерфейс. Очевидно, что это решение не масштабируется.

**Примечание**: Этот метод маршрутизации между VLAN больше не реализован в коммутируемых сетях и включен только для пояснений.

<!-- 4.1.3 -->
## Маршрутизация между сетями VLAN с использованием метода Router-on-a-Stick

Метод маршрутизации между VLAN «router-on-a-stick» преодолевает ограничение устаревшего метода маршрутизации между VLAN. Для маршрутизации трафика между несколькими сетями VLAN в сети требуется только один физический интерфейс Ethernet.

Интерфейс Ethernet маршрутизатора Cisco IOS настроен как магистральное соединение 802.1Q и подключен к магистральному порту коммутатора уровня 2. В частности, интерфейс маршрутизатора настраивается с использованием подинтерфейсов для идентификации маршрутизируемых VLAN.

Настроенные подинтерфейсы являются программными виртуальными интерфейсами. Каждый из них связан с одним физическим интерфейсом Ethernet. Подинтерфейсы настраиваются в программном обеспечении на маршрутизаторе. Каждому подинтерфейсу отдельно назначаются IP-адрес и длина префикса. Подинтерфейсы настроены для разных подсетей, которые соответствуют назначенным им VLAN. Это облегчает логическую маршрутизацию.

Когда трафик с тегом VLAN входит в интерфейс маршрутизатора, он перенаправляется на подинтерфейс VLAN. После принятия решения о маршрутизации на основе IP-адреса назначения маршрутизатор определяет интерфейс выхода для трафика. Если выходной интерфейс настроен как подинтерфейс 802.1q, Кадры данных помечены новой меткой VLAN отправляются обратно на физический интерфейс.

![](./assets/4.1.3.gif)

Как видно из анимации, PC1 на VLAN 10 взаимодействует с PC3 на VLAN 30. Маршрутизатор R1 принимает помеченный одноадресный трафик в сети VLAN 10 и направляет его в сеть VLAN 30 с помощью своих настроенных подынтерфейсов. Коммутатор S2 удаляет из одноадресного кадра метку сети VLAN и пересылает кадр на порт F0/23 компьютера PC3.

**Примечание**: Маршрутизация между VLAN с использованием метода router-on-a-stick не масштабируется при работе более 50 сетей VLAN.

<!-- 4.1.4 -->
## Маршрутизация между VLAN на коммутаторе уровня 3

Современный способ выполнения маршрутизации между VLAN заключается в использовании коммутаторов уровня 3 и коммутируемых виртуальных интерфейсов (SVI). Как показано на рисунке, SVI — это виртуальный интерфейс, настраиваемый в многоуровневом коммутаторе.

**Примечание**: Коммутатор уровня 3 также называется многоуровневым коммутатором, поскольку он работает на уровнях 2 и 3. Однако в этом курсе мы используем термин «Коммутатор уровня 3».

![](./assets/4.1.4.svg)


SVI для маршрутизации между VLAN создаются так же, как и интерфейс VLAN управления. Интерфейс SVI можно создать для любой сети VLAN, существующей на коммутаторе. Несмотря на то, что SVI является виртуальным, он выполняет те же функции для VLAN, что и интерфейс маршрутизатора. Интерфейс SVI для сети VLAN обеспечивает обработку пакетов 3-го уровня в обоих направлениях через порты коммутатора, связанные с этой VLAN.

Ниже приведены преимущества использования коммутаторов уровня 3 для маршрутизации между VLAN:

* Это более быстрая маршрутизация, чем конфигурация router-on-stick, поскольку и коммутация, и маршрутизация выполняются аппаратно.
* Для маршрутизации не требуются внешние каналы от коммутатора к маршрутизатору.
* Они не ограничиваются одним каналом, поскольку EtherChannels уровня 2 можно использовать в качестве магистральных каналов между коммутаторами для увеличения пропускной способности.
* Задержка намного короче, поскольку для маршрутизации в другую сеть данным не нужно покидать коммутатор.
* Они чаще развертываются в локальной сети кампуса, чем маршрутизаторы.

Единственным недостатком является то, что коммутаторы уровня 3 дороже.

<!-- 4.1.5 -->
<!-- quiz -->

