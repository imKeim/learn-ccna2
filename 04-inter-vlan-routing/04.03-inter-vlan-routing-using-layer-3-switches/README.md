<!-- 4.3.1 -->
## Маршрутизация на многоуровневых коммутаторах

Маршрутизация между VLAN с использованием метода ROS проста в реализации для малых и средних организаций. Однако крупному предприятию требуется более быстрый и более масштабируемый метод. Поэтому современные корпоративные сети редко используют метод ROS, так как он слишком сложно масштабируется, чтобы соответствовать требованиям.

Корпоративные локальные локальные сети предпочитают коммутаторы уровня 3 для обеспечения маршрутизации между VLAN. Эти устройства используют аппаратную коммутацию для достижения более высоких скоростей обработки пакетов, чем роутеры.

Возможности коммутатора уровня 3 помогают совершить ряд действий.

* Организовать маршрутизацию от одной VLAN к другой с использованием нескольких коммутируемых виртуальных интерфейсов (SVI).
* Преобразовать порт коммутатора уровня 2 в интерфейс уровня 3 (т.е. маршрутизируемый порт, простой интерфейс третьего уровня, аналогичный физическому интерфейсу на роутере Cisco IOS).

Для обеспечения маршрутизации между VLAN коммутаторы уровня 3 используют SVI. SVI настраиваются с помощью той же команды **interface vlan _vlan-id_**, которая используется для создания SVI управления на коммутаторе уровня 2. Для каждой маршрутизируемой сети VLAN необходимо создать SVI уровня 3.

<!-- 4.3.2 -->
## Пример сценария

На рисунке многоуровневый коммутатор D1 подключен к двум узлам в разных VLAN. PC1 находится в VLAN 10, а PC2 — в VLAN 20, как показано на рисунке. Коммутатор будет предоставлять услуги маршрутизации между VLAN.

![](./assets/4.3.2.svg)


В таблице показаны IP-адреса для каждой VLAN.

| Интерфейсы VLAN (SVI) | IP-адрес |
| --- | --- |
| 10 | 192.168.10.1/24 |
| 20 | 192.168.20.1/24 |

<!-- 4.3.3 -->
## Настройка многоуровневого коммутатора

Выполните следующие шаги для настройки D1 с созданием VLAN и магистральных каналов.

**Шаг 1**. Создайте сети VLAN.

**Шаг 2**. Создайте SVI-интерфейсы VLAN.

**Шаг 3**. Настройте порты доступа.

**Шаг 4**. Активируйте IP-маршрутизацию.

**1. Создайте сети VLAN**

Сначала создайте две VLAN, как показано на выходных данных.

```
D1(config)# vlan 10
D1(config-vlan)# name LAN10
D1(config-vlan)# vlan 20
D1(config-vlan)# name LAN20
D1(config-vlan)# exit
D1(config)#
```

**2. Создайте SVI-интерфейсы VLAN**

Затем создайте SVI для VLAN 10. Настроенные IP-адреса будут служить шлюзами по умолчанию для узлов в соответствующих VLAN. Обратите внимание на информационные сообщения, показывающие линейный протокол на обоих SVI, измененный на **up**.

```
D1(config)# interface vlan 10
D1(config-if)# description Default Gateway SVI for 192.168.10.0/24
D1(config-if)# ip add 192.168.10.1 255.255.255.0
D1(config-if)# no shut
D1(config-if)# exit
D1(config)#
D1(config)# int vlan 20
D1(config-if)# description Default Gateway SVI for 192.168.20.0/24
D1(config-if)# ip add 192.168.20.1 255.255.255.0
D1(config-if)# no shut
D1(config-if)# exit
D1(config)#
*Sep 17 13:52:16.053: %LINEPROTO-5-UPDOWN: Line protocol on Interface Vlan10, changed state to up
*Sep 17 13:52:16.160: %LINEPROTO-5-UPDOWN: Line protocol on Interface Vlan20, changed state to up
```

**3. Настройте порты доступа**

После настройте порты доступа, подключающиеся к узлам, и назначьте их соответствующим VLAN.

```
D1(config)# interface GigabitEthernet1/0/6
D1(config-if)# description Access port to PC1
D1(config-if)# switchport mode access
D1(config-if)# switchport access vlan 10
D1(config-if)# exit
D1(config)#
D1(config)# interface GigabitEthernet1/0/18
D1(config-if)# description Access port to PC2
D1(config-if)# switchport mode access
D1(config-if)# switchport access vlan 20
D1(config-if)# exit
```

**4. Активируйте IP-маршрутизацию**

Наконец, включите маршрутизацию IPv4 с помощью команды глобальной конфигурации **ip routing**, чтобы разрешить обмен трафиком между VLAN 10 и 20. Эта команда должна быть настроена для включения маршрутизации между VAN на коммутаторе уровня 3 для протокола IPv4.

```
D1(config)# ip routing
D1(config)#
```

<!-- 4.3.4 -->
## Проверка связности

Маршрутизация между VLAN с помощью многоуровневого коммутатора проще в настройке, чем метод ROS. После завершения настройки конфигурация может быть проверена путем тестирования подключения между узлами.

Проверьте подключение к узлу в другой VLAN с помощью команды **ping**. Лучше сначала проверить текущую конфигурацию IP хоста с помощью команды Windows **ipconfig**. Выходные данные подтверждают IPv4-адрес и шлюз по умолчанию PC1.

```
C:\Users\PC1> ipconfig
Windows IP Configuration
Ethernet adapter Ethernet0:
  Connection-specific DNS Suffix . :
  Link-local IPv6 Address          : fe80::5c43:ee7c:2959:da68%6
  IPv4 Address                     : 192.168.10.10
  Subnet Mask                      : 255.255.255.0
  Default Gateway                  : 192.168.10.1
C:\Users\PC1> 
```

Затем проверьте подключение к PC2 с помощью команды Windows **ping**, как показано на выходных данных, которые успешно подтверждают работу маршрутизации между VLAN.

```
C:\Users\PC1> ping 192.168.20.10
Pinging 192.168.20.10 with 32 bytes of data:
Reply from 192.168.20.10: bytes=32 time<1ms TTL=127
Reply from 192.168.20.10: bytes=32 time<1ms TTL=127
Reply from 192.168.20.10: bytes=32 time<1ms TTL=127
Reply from 192.168.20.10: bytes=32 time<1ms TTL=127
Ping statistics for 192.168.20.10:
    Packets: Sent = 4, Received = 4, Lost = 0 (0% loss),
Approximate round trip times in milli-seconds:
    Minimum = 0ms, Maximum = 0ms, Average = 0ms
C:\Users\PC1>
```

<!-- 4.3.5 -->
## Маршрутизация на многоуровневом коммутаторе

Если VLAN должны быть доступны другим устройствам уровня 3, их нужно обозначить с помощью статической или динамической маршрутизации. Чтобы включить маршрутизацию на коммутаторе уровня 3, необходимо настроить порт.

Маршрутизированный порт создается на коммутаторе уровня 3 путем отключения функции порта коммутатора на порту уровня 2, соединенном с другим устройством уровня 3. В частности, настройка команды конфигурации интерфейса **no switchport** на порту уровня 2 преобразует его в интерфейс уровня 3. Затем интерфейс может быть настроен с конфигурацией IPv4 для подключения к роутеру или другому коммутатору уровня 3.

<!-- 4.3.6 -->
## Сценарий маршрутизации на многоуровневом коммутаторе

На рисунке ранее настроенный коммутатор D1 уровня 3 теперь подключен к R1. R1 и D1 находятся в домене протокола маршрутизации OSPF. Предположим, что маршрутизация между VLAN успешно реализована на D1. Интерфейс G0/0/1 R1 также был настроен и включен. Кроме того, R1 использует OSPF для объявления своих двух сетей: 10.10.10.0/24 и 10.20.0/24.

**Примечание.** Настройка маршрутизации OSPF рассматривается в другом курсе. В этом модуле команды конфигурации OSPF будут даны вам во всех задания и экзаменах. Для включения маршрутизации OSPF на коммутаторе уровня 3 не требуется понимание конфигурации.

![](./assets/4.3.6.svg)


<!-- 4.3.7 -->
## Конфигурация маршрутизации на многоуровневом коммутаторе

Выполните следующие шаги, чтобы настроить D1 для маршрутизации с R1.

**Шаг 1**. Настройте маршрутизируемый порт.

**Шаг 2**. Включите маршрутизацию.

**Шаг 3**. Настройте маршрутизацию.

**Шаг 4**. Проверьте маршрутизацию.

**Шаг 5**. Проверьте подключение.

**1. Настройте маршрутизируемый порт**

Настройте G1/0/1 как маршрутизируемый порт, назначьте ему IPv4-адрес и включите его.

```
D1(config)# interface GigabitEthernet1/0/1
D1(config-if)# description routed Port Link to R1
D1(config-if)# no switchport
D1(config-if)# ip address 10.10.10.2 255.255.255.0
D1(config-if)# no shut
D1(config-if)# exit
D1(config)#
```

**2. Включите маршрутизацию**

Убедитесь, что маршрутизация IPv4 включена с помощью команды глобальной конфигурации **ip routing**.

```
D1(config)# ip routing
D1(config)#
```

**3. Настройте маршрутизацию**

Настройте протокол маршрутизации OSPF для объявления сетей VLAN 10 и VLAN 20 вместе с сетью, подключенной к R1. Обратите внимание на сообщение, информирующее вас о том, что соединение с R1 установлено.

```
D1(config)# router ospf 10
D1(config-router)# network 192.168.10.0 0.0.0.255 area 0
D1(config-router)# network 192.168.20.0 0.0.0.255 area 0
D1(config-router)# network 10.10.10.0 0.0.0.3 area 0
D1(config-router)# ^Z
D1#
*Sep 17 13:52:51.163: %OSPF-5-ADJCHG: Process 10, Nbr 10.20.20.1 on GigabitEthernet1/0/1 from LOADING to FULL, Loading Done
D1#
```

**4. Проверьте маршрутизацию**

Проверьте таблицу маршрутизации D1. Обратите внимание, что D1 теперь имеет маршрут к сети 10.20.20.0/24.

```
D1# show ip route | begin Gateway
Gateway of last resort is not set
      10.0.0.0/8 is variably subnetted, 3 subnets, 3 masks 
C 10.10.10.0/30 is directly connected, GigabitEthernet1/0/1
L 10.10.10.2/32 is directly connected, GigabitEthernet1/0/1
O 10.20.20.0/24 [110/2] via 10.10.10.1, 00:00:06, GigabitEthernet1/0/1
      192.168.10.0/24 is variably subnetted, 2 subnets, 2 masks
C 192.168.10.0/24 is directly connected, Vlan10
L 192.168.10.1/32 is directly connected, Vlan10
      192.168.20.0/24 is variably subnetted, 2 subnets, 2 masks
C 192.168.20.0/24 is directly connected, Vlan20
L 192.168.20.1/32 is directly connected, Vlan20
D1#
```

**5. Проверьте подключение**

В это время PC1 и PC2 могут выполнить эхо-запрос сервера, подключенного к R1.

```
C:\Users\PC1> ping 10.20.20.254
Pinging 10.20.20.254 with 32 bytes of data: 
Request timed out.
Reply from 10.20.20.254: bytes=32 time<1ms TTL=127
Reply from 10.20.20.254: bytes=32 time<1ms TTL=127
Reply from 10.20.20.254: bytes=32 time<1ms TTL=127
Ping statistics for 10.20.20.254:
    Packets: Sent = 4, Received = 3, Lost = 1 (25% loss).
Approximate round trip times in milli-seconds: 
    Minimum = 1ms, Maximum = 2ms, Average = 1ms 
C:\Пользователи\ PC1>
! ================================================
C:\Users\PC2> ping 10.20.20.254
Pinging 10.20.20.254 with 32 bytes of data: 
Reply from 10.20.20.254: bytes=32 time<1ms TTL=127
Reply from 10.20.20.254: bytes=32 time<1ms TTL=127
Reply from 10.20.20.254: bytes=32 time<1ms TTL=127
Reply from 10.20.20.254: bytes=32 time<1ms TTL=127
Ping statistics for 10.20.20.254:
    Packets: Sent = 4, Received = 4, Lost = 0 (0% loss).
Approximate round trip times in milli-seconds: 
    Minimum = 1ms, Maximum = 2ms, Average = 1ms
C:\Users\PC2> 
```
