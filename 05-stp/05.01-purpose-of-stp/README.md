<!-- 5.1.1 -->
## Резервирование в коммутируемых сетях

В этом разделе рассматриваются причины возникновения петель в коммутируемых сетях и кратко описывается, как работает протокол связующего дерева. Резервирование является важной частью иерархической модели, предотвращающей перебои в оказании сетевых сервисов пользователям. Для сетей с резервированием требуется добавление физических путей, но необходимо также предусмотреть и логическое резервирование. Наличие альтернативных физических каналов для передачи данных по сети позволяет получить доступ к сетевым ресурсам даже в случае сбоя одного из каналов. Тем не менее избыточные маршруты в коммутируемой сети Ethernet могут привести к возникновению физических и логических петель второго уровня.

Для локальных сетей Ethernet требуется топология без петель с одним путем между любыми двумя устройствами. Петля в такой сети может вызывать постоянное распространение кадров Ethernet до тех пор, пока соединение не будет разорвано и это не ликвидирует петлю.

<!-- 5.1.2 -->
## Протокол STP

**Протокол связующего дерева** (Spanning Tree Protocol, STP) – это сетевой протокол предотвращения петель, который обеспечивает работу при создании топологии уровня 2 без петель. IEEE 802.1D является исходным стандартом IEEE MAC соединения мостов для STP.

Посмотрите на работу STP в нормальном режиме.

![](./assets/5.1.2.png "STP Normal Operation")

<!-- 5.1.3 -->
## Перестройка STP

Посмотрите анимацию пересчета STP в случае сбоя.

![](./assets/5.1.3.png "STP Compensates for Network Failure")

На анимации видно, что произошел сбой в работе транкового канала между S1 и S2. S2 разблокирует порт для Trunk2. Компьютер PC1 отправляет широковещательный кадр на S2. S2 пересылает его из всех портов, за исключением источника и неисправного канала для Trunk1. S3 пересылает его из всех доступных портов, за исключением источника. S1 передает его только из F0/3.

<!-- 5.1.4 -->
## Проблемы с избыточными каналами коммутатора

Резервирование путей обеспечивает необходимую доступность множества сетевых сервисов, устраняя вероятпри ность перебоев в работе всех сетевых служб в случае отказа в отдельной точке. При наличии нескольких путей между двумя устройствами и отсутствии реализации STP возникает петля второго уровня. Она может привести к нестабильности таблицы MAC-адресов, перегрузке каналов и высокой загрузке ЦП на коммутаторах и оконечных устройствах, в результате чего сеть становится непригодной для использования.

В отличие от протоколов уровня 3, IPv4 и IPv6, уровень 2 Ethernet не включает в себя механизм распознавания и устранения бесконечно зацикливающихся кадров. Некоторые протоколы третьего уровня используют механизмы времени жизни (TTL), которые ограничивают количество попыток повторной передачи пакетов сетевыми устройствами этого же уровня. Роутер уменьшит TTL (Time to Live) в каждом пакете IPv4 и поле Hop Limit в каждом пакете IPv6. Когда эти поля уменьшатся до 0, маршрутизатор отбрасывает пакет. Коммутаторы Ethernet и Ethernet не имеют сопоставимого механизма ограничения числа раз, когда коммутатор передает кадр уровня 2. STP был разработан специально в качестве механизма предотвращения петли для Ethernet уровня 2.

<!-- 5.1.5 -->
## Петли второго уровня

Без включения STP петли уровня 2 могут формироваться, что приводит к бесконечному циклу широковещательных, многоадресных и неизвестных одноадресных кадров. Это может привести к разрушению сети в течение очень короткого промежутка времени, иногда всего за несколько секунд. Например, широковещательные кадры, такие как запрос ARP, перенаправляются на все порты коммутатора, кроме исходного входного порта. Это гарантирует, что все устройства в домене широковещательной рассылки могут получить кадр. При наличии более одного пути, из которого пересылается кадр, может возникнуть бесконечная петля. Из-за этого появляется угроза постоянного изменения таблицы MAC-адресов на коммутаторе обновлениями из кадров широковещательной рассылки, что приводит к нестабильности базы данных MAC-адресов. Это может привести к высокой загрузке ЦП и выводу коммутатора из рабочего состояния.

Кадры широковещательной рассылки являются не единственным типом кадров, на которые провоцируют возникновение петель. Неизвестные одноадресные кадры, отправленные в циклическую сеть, могут приводить к появлению дублирующихся кадров, поступающих на целевое устройство. Неизвестный одноадресный кадр с коммутатора формируется, когда у устройства нет MAC-адреса назначения в таблице, и оно должно переслать этот кадр со всех своих портов, за исключением входного.

Посмотрите анимацию и прочитайте текст, описывающий действие.

![](./assets/5.1.5.png)


<!-- 5.1.6 -->
## Широковещательный шторм

**Широковещательный шторм** – это ненормально большое количество широковещательных передач, подавляющих сеть в течение определенного периода времени. Подобные явления могут отключить сеть за считанные секунды, перегружая коммутаторы и оконечные устройства. Они возникают, например, из-за неисправности сетевого адаптера или петли второго уровня в сети.

Широковещательные рассылки уровня 2 в сети, такие как ARP-запросы, очень распространены. Петля на этом уровне, вероятно, будет иметь мгновенные и разрушительные последствия в сети. Многоадресные рассылки второго уровня обычно пересылаются так же, как и широковещательные. Таким образом, хотя пакеты IPv6 никогда не пересылаются как широковещательная передача уровня 2, ICMPv6 Neighbor Discovery использует многоадресную рассылку этого уровня.

Просмотрите анимацию, которая демонстрирует все более неблагоприятные последствия петли, поскольку широковещательные и неизвестные кадры одноадресной передачи продолжают распространяться в результате широковещательного шторма.

![](./assets/5.1.6.png)

Узел, участвующий в сетевой петле, недоступен для других узлов в сети. Кроме того, вследствие постоянных изменений в таблице MAC-адресов коммутатор не знает, из какого порта следует пересылать кадры одноадресной рассылки. В вышеуказанном примере для PC1 перечислены неправильные порты. Любой одноадресный кадр, предназначенный для PC1, пересылается в сети по петле, подобно широковещательным кадрам. Из-за возрастающего числа кадров, формирующих петлю в сети, в конечном итоге образуется широковещательный шторм.

Во избежание подобных проблем в сети, на коммутаторах должны быть включены определённые типы STP. Этот протокол по умолчанию включен на коммутаторах Cisco, предотвращая, таким образом, возникновение петель второго уровня.

<!-- 5.1.7 -->
## Алгоритм оставного (связующего) дерева (Spanning-Tree Algorithm)

Протокол STP основан на алгоритме, изобретенном Радией Перлман (Radia Perlman) во время ее работы в Digital Equipment Corporation и опубликованном в статье 1985 года «Алгоритм распределенного вычисления протокола связующего дерева в расширенной сети LAN» (An Algorithm for Distributed Computation of a Spanning Tree in an Extended LAN). Ее алгоритм связующего дерева (STA) создает топологию без петли, выбрав один корневой мост, где все остальные коммутаторы определяют один путь с наименьшей стоимостью.

Без этого протокола возникли бы петли, делающие резервную коммутируемую сеть неработоспособной.

**Сценарий топологии STA**

В этом сценарии STA используется сеть Ethernet с резервными соединениями между несколькими коммутаторами.

![](./assets/5.1.7-1.svg)


**Выбор корневого мост**

STA начинается с выбора одного корневого моста. На рисунке показано, что в качестве корневого моста был выбран коммутатор S1. В этой топологии все каналы имеют одинаковую стоимость (та же пропускная способность). Каждый коммутатор определяет от себя до корневого моста один путь с наименьшей стоимостью.

**Примечание.** STA и STP называют коммутаторы мостами. Это связано с тем, что изначально Ethernet-коммутаторы назывались именно так.

![](./assets/5.1.7-2.svg)


**Блокировка избыточных путей**

Протокол STP обеспечивает наличие только одного логического пути между всеми узлами назначения в сети путем намеренного блокирования резервных путей, которые могли бы вызвать петлю. Порт считается заблокированным, когда на нем заблокированы отправка и прием данных. Для предотвращения петель в сети чрезвычайно важно блокировать резервные пути.

![](./assets/5.1.7-3.svg)


Коммутаторы S4, S5 и S8 заблокировали резервные пути к корневому мосту.

**Топология без петель**

Заблокированный порт приводит к тому, что эта ссылка не работает между двумя коммутаторами, как показано на рисунке. Обратите внимание, что это создает топологию, в которой каждый коммутатор имеет только один путь к корневому мосту, аналогично ветвям дерева, которые подключаются к его корню.

![](./assets/5.1.7-4.svg)


Теперь у каждого коммутатора есть только один путь пересылки данных к корневому мосту.

**Сбой связи вызывает перерасчет**

Физические пути по-прежнему используются для обеспечения резерва, но они отключены в целях предотвращения петель. Если путь потребуется для компенсации неисправности сетевого кабеля или коммутатора, протокол STP повторно рассчитывает маршрут и снимет блокировку с требуемых портов, чтобы разрешить активацию резервного пути. Перерасчет STP также может происходить в любой момент, когда новый коммутатор или новый межкоммутационный канал добавляется в сеть.

На рисунке показан сбой канала между коммутаторами S2 и S4, который приводит к перерасчету STP. Обратите внимание, что ранее резервный канал между S4 и S5 теперь перенаправляется для компенсации этого сбоя. Между каждым коммутатором и корневым мостом остается только один путь.

![](./assets/5.1.7-5.svg)


Протокол STP предотвращает возникновение петель за счет настройки беспетлевого пути в сети с использованием портов, стратегически настроенных на заблокированное состояние. Коммутаторы, использующие протокол STP, могут компенсировать сбои за счет динамической разблокировки ранее блокированных портов и разрешения передачи трафика по альтернативным путям.

<!-- 5.1.8 -->
## Видео: наблюдение за работой STP

Посмотрите видео о работе протокола STP.

![youtube](https://www.youtube.com/watch?v=TZrrTw5uhNI)
