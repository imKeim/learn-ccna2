<!-- 5.4.1 -->
## Назначение протокола STP

Резервные маршруты в коммутируемой сети Ethernet могут привести к возникновению физических и логических петель второго уровня. Они могут привести к нестабильности таблицы MAC-адресов, перегрузке каналов и высокой загрузке ЦП на коммутаторах и конечных устройствах. Это приводит к тому, что сеть становится непригодной для использования. В отличие от протоколов уровня 3, IPv4 и IPv6, второй уровень Ethernet не включает в себя механизм распознавания и устранения бесконечно зацикливающихся кадров. Для локальных сетей Ethernet требуется топология без петель с одним путем между любыми двумя устройствами.

**STP** — это сетевой протокол предотвращения петли, который позволяет резервировать при создании топологии уровня 2 без петли. Без STP могут образовываться петли второго уровня, что приводит к бесконечному циклу широковещательных, многоадресных и неизвестных одноадресных кадров, что приводит к разрушению сети. **Широковещательный шторм** — это ненормально большое количество широковещательных передач, подавляющих сеть в течение определенного периода времени. Такие явления могут отключить сеть за считанные секунды, перегружая коммутаторы и оконечные устройства. STP основан на алгоритме, изобретенном Радией Перлман. Ее алгоритм связующего дерева (STA) создает топологию без петли, выбрав один корневой мост, где все остальные коммутаторы определяют один путь с наименьшей стоимостью.

## Принцип работы STP

Используя STA, STP строит топологию без петли в четырехэтапном процессе: выбор корневого моста, а также корневых, назначенных и альтернативных (заблокированных) портов. Во время функций STA и STP коммутаторы используют BPDU для обмена информацией о себе и своих подключениях.

BPDU используются для выбора корневого моста, корневых, назначенных и альтернативных портов. Каждый BPDU содержит идентификатор BID, который определяет коммутатор, отправивший BPDU. BID участвует в принятии многих решений STA, включая роли корневого моста и портов. Идентификатор BID содержит значение приоритета, MAC-адрес отправляющего коммутатора и дополнительный расширенный идентификатор системы. Самое низкое значение BID определяется комбинацией значений в этих трех полях. Коммутатор с самым низким значением BID становится корневым мостом. Поскольку BID по умолчанию равен 32768, два или более коммутаторов могут иметь одинаковый приоритет. В этом сценарии, где приоритеты одинаковы, коммутатор с самым низким MAC-адресом станет корневым мостом.

Если корневой мост выбран для экземпляра STP, STA начинает процесс определения оптимальных путей к корневому мосту от всех некорневых коммутаторов в домене широковещательной рассылки. Информация о пути, известная как стоимость внутреннего корневого пути, равна сумме стоимости отдельных портов на пути от коммутатора к корневому мосту. После определения корневого моста алгоритм STA выбирает корневой порт. Он является ближайшим к корневому мосту портом с точки зрения общей стоимости, которая называется стоимостью внутреннего корневого пути. После того, как каждый коммутатор выбирает корневой порт, коммутаторы будут выбирать назначенные порты.

**Назначенный порт** — это порт в сегменте с двумя коммутаторами, который имеет стоимость внутреннего корневого пути к корневому мосту. Если порт не является корневым или назначенным, он становится альтернативным (или резервным). **Альтернативные и резервные порты** — находятся в состоянии отклонения или блокирования для предотвращения петель. Если коммутатор имеет несколько путей равной стоимости к корневому мосту, коммутатор определяет порт по следующим критериям: самый низкий BID отправителя, затем самый низкий приоритет порта отправителя и, наконец, самый низкий идентификатор порта отправителя.

Для конвергенции STP требуется **три таймера**: таймер приветствия, таймер задержки пересылки и таймер максимального возраста. **Пять состояний** — это блокирование, прослушивание, обучение, пересылка и отключенное состояние. В PVST-версиях STP для каждого экземпляра связующего дерева выбирается корневой мост. Возможно наличие нескольких отдельных корневых мостов для различных наборов VLAN.

## Эволюция STP

Однако использование этого термина и этой аббревиатуры может быть двусмысленным. STP часто используется для обозначения различных реализаций связующего дерева, таких как RSTP и MSTP. Развитие STP, обеспечивающее более быструю сходимость STP, дало возможность появления RSTP, который определяет следующие состояния портов: отбрасывание, изучение или пересылка.

PVST+ является усовершенствованным протоколом компании Cisco, в котором для каждой отдельной VLAN используется отдельный экземпляр RSTP. Рассматриваемый вариант STP поддерживает PortFast, UplinkFast, BackboneFast, BPDU guard, BPDU filter, root guard и loop guard. Коммутаторы Cisco под управлением IOS 15.0 или более поздней версии по умолчанию запускают PVST+.

**Rapid PVST+** — это усовершенствованная технология RSTP Cisco, которая использует PVST+ и предоставляет отдельный экземпляр 802.1w на VLAN. Если порт коммутатора настроен с помощью функции PortFast, он сразу переходит из состояния блокировки в состояние пересылки, минуя стандартные состояния перехода STP 802.1D (состояния прослушивания и получения данных).

Вместо того, чтобы ожидать соединения протокола STP IEEE 802.1D в каждой VLAN, PortFast можно использовать на портах доступа для обеспечения немедленного подключения этих устройств к сети. Коммутаторы Cisco поддерживают функцию BPDU guard, которая сразу же ставит порт коммутатора в состояние отключенной ошибки после получения любого BPDU для защиты от потенциальных петель.

На протяжении многих лет сети Ethernet шли от нескольких взаимосвязанных коммутаторов, подключенных к одному роутеру, к сложной иерархической структуре сети. В зависимости от реализации уровень 2 может включать не только уровень доступа, но и распределение или даже уровни ядра. Эти топологии могут содержать сотни коммутаторов с сотнями или даже тысячами VLAN.

STP адаптировалась к дополнительному резерву и сложности благодаря усовершенствованиям в рамках RSTP и MSTP. Маршрутизация уровня 3 позволяет создавать избыточные пути и петли в топологии без блокировки портов. По этой причине некоторые среды переходят на уровень 3 везде, за исключением тех случаев, когда устройства подключаются к коммутатору уровня доступа.

<!-- 5.4.2 -->
<!-- quiz -->
