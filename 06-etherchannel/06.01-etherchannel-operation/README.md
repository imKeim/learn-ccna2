<!-- 6.1.1 -->
## Агрегирование каналов

Существуют сценарии, в которых требуется большая пропускная способность или резерв между устройствами, что может быть обеспечено одним каналом. Множественные каналы могут быть соединены между устройствами для увеличения пропускной способности. Однако STP, который по умолчанию включен на устройствах уровня 2, таких как коммутаторы Cisco, блокирует резервные каналы, чтобы предотвратить возникновение петли коммутации, как показано на рисунке.

Необходима технология агрегации каналов, позволяющая создавать резервные связи между устройствами, которые не будут блокироваться STP. Эта технология известна как EtherChannel.

**EtherChannel** — это технология агрегации каналов, которая группирует несколько физических каналов Ethernet в один логический. Он используется для обеспечения устойчивости к сбоям, распределения нагрузки, увеличения пропускной способности и резерва между коммутаторами, роутерами и серверами.

Технология EtherChannel может объединить несколько физических каналов между коммутаторами, что позволит увеличить общую скорость обмена данными между этими устройствами.

![](./assets/6.1.1.svg)


По умолчанию протокол STP блокирует резервные каналы.

<!-- 6.1.2 -->
## EtherChannel

Технология EtherChannel изначально была разработана компанией Cisco как технология LAN типа «коммутатор-коммутатор» для объединения нескольких портов Fast Ethernet или Gigabit Ethernet в один логический канал. При настройке EtherChannel создается виртуальный интерфейс, который называется агрегированный канал (port channel). Физические интерфейсы объединяются в его интерфейс, как показано на рисунке.

![](./assets/6.1.2.svg)


<!-- 6.1.3 -->
## Преимущества EtherChannel

Технология EtherChannel имеет много достоинств.

* Большинство задач конфигурации выполняется на интерфейсе EtherChannel, а не на отдельных портах. Это обеспечивает согласованную конфигурацию на всех каналах.
* EtherChannel использует существующие порты коммутатора. Для обеспечения более высокой пропускной способности не требуется дорогостоящая замена канала на более быстрый.
* Между каналами, которые являются частью одного и того же EtherChannel, происходит распределение нагрузки. В зависимости от используемого оборудования может быть реализован один или несколько методов балансировки нагрузки. К этим методам относятся, например, распределение нагрузки по физическим каналам на основе МАС-адресов источника и назначения или на основе IP-адресов источника и назначения.
* EtherChannel создает объединение, которое рассматривается, как один логический канал. Если между двумя коммутаторами существует несколько объединений EtherChannel, STP может блокировать одно из них во избежание петель коммутации. Если происходит блокировка одного из ирезервных каналов, блокируется весь EtherChannel, в том числе все относящиеся к нему порты. Если существует только один канал EtherChannel, все физические каналы в EtherChannel активны, поскольку STP видит только один (логический) канал.
* EtherChannel предоставляет функции резервности, поскольку общий канал считается одним логическим соединением. Кроме того, потеря одного физического соединения в пределах канала не приводит к изменению в топологии. Поэтому перерасчет STP не требуется. При условии, что имеется хотя бы одно физическое соединение, EtherChannel продолжает работать даже в том случае, если общая пропускная способность снижается из-за потери соединения в его пределах.

<!-- 6.1.4 -->
## Ограничения использования

EtherChannel имеет определенные ограничения реализации.

* Нельзя одновременно использовать разные типы интерфейсов. Например, нельзя смешивать Fast Ethernet и Gigabit Ethernet в пределах одного канала EtherChannel.
* В настоящее время все каналы EtherChannel могут содержать до восьми совместимо настроенных Ethernet-портов. EtherChannel предоставляет полнодуплексную полосу пропускания до 800 Мбит/с (Fast EtherChannel) или 8 Гбит/с (Gigabit EtherChannel) между двумя коммутаторами или между коммутатором и узлом.
* Коммутатор Cisco Catalyst 2960 уровня 2 в настоящее время поддерживает до шести каналов EtherChannel. Тем не менее с появлением новых версий IOS и изменением платформ некоторые карты и платформы могут получить возможность поддерживать большее количество портов в пределах одного канала EtherChannel, а также большее количество каналов Gigabit EtherChannel.
* Конфигурация порта отдельного участника группы EtherChannel должна выполняться согласованно на обоих устройствах. Если физические порты на одной стороне настроены в качестве транковых, физические порты на другой стороне также должны быть настроены в качестве транковых с тем же самым Native VLAN. Кроме того, все порты в каждом канале EtherChannel должны быть настроены как порты второго уровня.
* Каждый EtherChannel имеет логический интерфейс агрегированного канала. Его настройка применяется на все физические интерфейсы, связанные с этим логическим интерфейсом.

![](./assets/6.1.4.svg)

<!-- 6.1.5 -->
## Протоколы автосогласования

EtherChannel можно образовать путем согласования с использованием одного из двух протоколов — Port Aggregation Protocol (PAgP) или Link Aggregation Control Protocol (LACP). Данные протоколы позволяют портам со сходными характеристиками образовывать каналы путем динамического согласования со смежными коммутаторами.

**Примечание.** Также возможна настройка статического или безусловного канала EtherChannel без использования PAgP или LACP.

<!-- 6.1.6 -->
## Функции PAgP

**PAgP** — это проприетарный протокол Cisco, который предназначен для автоматизации создания каналов EtherChannel. Когда канал EtherChannel настраивается с помощью PAgP, пакеты этого протокола пересылаются между портами с поддержкой EtherChannel в целях согласования создания канала. Когда PAgP определяет совпадающие соединения Ethernet, он группирует их в канал EtherChannel. Далее EtherChannel добавляется в дерево кратчайших путей как один порт.

Если включен PAgP, он также участвует в управлении EtherChannel. Отправка пакетов PAgP выполняется с интервалом в 30 секунд. PAgP проверяет согласованность конфигурации и обрабатывает добавление и выход из строя каналов между двумя коммутаторами. Таким образом обеспечивается использование согласованной конфигурации для всех портов при создании EtherChannel.

**Примечание.** В EtherChannel все порты обязательно должны иметь одинаковые скорость, настройки дуплекса и настройки VLAN. При любом изменении порта после создания канала также изменяются все остальные порты канала.

PAgP позволяет создать EtherChannel путем обнаружения конфигурации на каждой из сторон и обеспечения совместимости каналов, чтобы EtherChannel мог быть включен в случае необходимости.

**Режимы PAgP**

* **On** (включено) — режим принудительно назначает интерфейс в канал без использования PAgP. Интерфейсы, настроенные в этом режиме, не обмениваются пакетами PAgP.
* **PAgP desirable** (рекомендуемый) — режим PAgP помещает интерфейс в активное состояние согласования, в котором инициируется согласование с другими интерфейсами путем отправки пакетов PAgP.
* **PAgP auto** (автоматический) — режим PAgP помещает интерфейс в пассивное состояние согласования, в котором интерфейс отвечает на полученные пакеты PAgP, но не инициирует их согласование.

Режимы должны быть совместимыми на каждой из сторон. Если одна из них настроена в автоматическом режиме, она помещается в пассивное состояние, ожидая инициации согласования EtherChannel другой стороной. Если для другой стороны также задан автоматический режим, согласование не начнется и EtherChannel не образуется. Если все режимы отключены с помощью команды **no** или ни один из них не настроен, EtherChannel отключается.

Режим **On** помещает интерфейс в канал EtherChannel без выполнения согласования. Он работает только в том случае, если для другой стороны также задан аналогичный режим. Если для другой стороны параметры согласования заданы с помощью PAgP, образование EtherChannel не выполнится, поскольку та сторона, для которой задан режим **On**, не выполняет согласование.

Если между двумя коммутаторами нет согласования, что отсутствует проверка, все каналы в EtherChannel завершаются на другой стороне или на другом коммутаторе используются совместимые параметры PAgP.

<!-- 6.1.7 -->
## Пример настроек режима PAgP

Рассмотрим два коммутатора на рисунке. Установит ли S1 и S2 EtherChannel с помощью PAgP, зависит от настроек режима на каждой стороне канала.

![](./assets/6.1.7.svg)


В таблице показаны различные сочетания режимов PAgP на S1 и S2 и результат создания канала.

| **S1** | **S2** | **Формирование канала** |
| --- | --- | --- |
| Включено | Включено | Да |
| Вкл | Рекомендуемый/Автоматический | Нет |
| Рекомендуемый | Рекомендуемый | Да |
| Рекомендуемый | Авто | Да |
| Автоматически | Рекомендуемый | Да |
| Автоматически | Автоматически | Нет |

<!-- 6.1.8 -->
## Функции LACP

LACP определяется стандартом IEEE (802.3ad), который обеспечивает возможность объединения нескольких физических портов для создания единого логического канала. Он помогает согласовывавть коммутатором автоматическое объединение путем отправки пакетов LACP на другой коммутатор. Он выполняет функцию, сходную с функциями PAgP для Cisco EtherChannel. Поскольку протокол LACP относится к стандарту IEEE, его можно использовать для упрощения работы с EtherChannel в неоднородных средах. На устройствах Cisco поддерживаются оба протокола.

**Примечание.** LACP изначально определен как стандарт IEEE 802.3ad. Тем не менее теперь протокол LACP определяется более новой версией, стандартом IEEE 802.1AX для локальных и городских сетей.

Протокол LACP предоставляет те же преимущества при согласовании, что и протокол PAgP. Протокол LACP позволяет создать канал EtherChannel путем обнаружения конфигурации на каждой из сторон и обеспечения совместимости каналов, чтобы канал EtherChannel мог быть включён в случае необходимости.

**Режимы LACP**

* **On** (Вкл) — режим принудительно помещает интерфейс в канал без использования LACP. Интерфейсы, настроенные в этом режиме, не обмениваются пакетами LACP.
* **LACP active** (активный) — порт помещается в активное состояние согласования. Он инициирует согласование с другими портами путем отправки пакетов LACP.
* **LACP passive** (пассивный) —  порт помещается в пассивное состояние согласования. Он отвечает на полученные пакеты LACP, но не инициирует их согласование.

Как и в случае с PAgP, для формирования EtherChannel режимы должны быть совместимы на обеих сторонах. Режим **On** повторяется, поскольку он создает конфигурацию EtherChannel безусловно, без динамического согласования PAgP или LACP.

LACP позволяет создать восемь активных, а также восемь резервных каналов. Резервный канал становится активным при сбое одного из текущих активных.

<!-- 6.1.9 -->
## Пример настроек режима LACP

Рассмотрим два коммутатора на рисунке. Установит ли S1 и S2 EtherChannel с помощью LACP, зависит от настроек режима на каждой стороне канала.

![](./assets/6.1.9.svg)


В таблице показаны различные комбинации режимов LACP на S1 и S2 и полученные результаты создания канала.

| **S1** | **S2** | **Формирование канала** |
| --- | --- | --- |
| Включено | Включено | Да |
| Вкл | Активный/Пассивный | Нет |
| Активный | Active | Да |
| Активный | Пассивный | Да |
| Пассивный | Active | Да |
| Пассивный | Пассивный | Нет |

<!-- 6.1.10 -->
<!-- quiz -->

