<!-- 9.1.1 -->
## Ограничения шлюза по умолчанию

В случае сбоя роутера или его интерфейса, выступающего в качестве шлюза по умолчанию, узел, для которого настроено использование этого шлюза, изолируется от внешних сетей. Требуется механизм для предоставления альтернативных шлюзов по умолчанию в коммутируемых сетях, где два или более роутеров подключены к одним и тем же VLAN. Этот механизм обеспечивается **протоколами резервирования первого перехода** (FHRP).

В коммутируемой сети все клиенты получают только один шлюз по умолчанию. Невозможно использовать дополнительный шлюз, даже если существует второй путь для передачи пакетов из локального сегмента.

На рисунке R1 отвечает за маршрутизацию пакетов от PC1. В случае его недоступности протоколы маршрутизации выполняют динамическое схождение. Теперь R2 маршрутизирует пакеты из внешних сетей, которые должны были пройти через R1. Тем не менее трафик из внутренней сети, связанный с R1, включая трафик с рабочих станций, серверов и принтеров, для которых R1 настроен в качестве шлюза по умолчанию, до сих пор отправляется на R1 и сбрасывается.

**Примечание.** В рамках обсуждения обеспечения резерва роутера, мы не делаем функциональное различие между многоуровневым коммутатором и роутером на уровне распределения. На практике многоуровневые коммутаторы часто выступают в роли шлюза по умолчанию для всех VLAN в коммутируемой сети. В этом обсуждении основное внимание уделяется функциональности маршрутизации, независимо от используемого физического устройства.

![](./assets/9.1.1.svg)


PC1 не может подключиться к шлюзу по умолчанию.

Оконечные устройства, как правило, настраиваются с одним IP-адресом для шлюза по умолчанию. Этот адрес не изменяется при редактировании топологии сети. Если IP-адрес шлюза по умолчанию недоступен, локальное устройство не может отправлять пакеты из локального сегмента сети, что по факту отключает это устройство от остальных сетей. Даже при наличии резервного роутера, который может выступать в качестве шлюза по умолчанию для этого сегмента, динамический метод, с помощью которого эти устройства могут определять адрес нового шлюза по умолчанию, недоступен.

**Примечание.** Устройства IPv6 получают адрес шлюза по умолчанию динамически из сообщения RA ICMPv6. Однако при использовании FHRP устройства IPv6 получают более быстрое переключение на новый шлюз по умолчанию.

<!-- 9.1.2 -->
## Резервирование роутеров

Один из способов устранения единой точки отказа на шлюзе по умолчанию — реализация виртуального роутера. Для этого несколько устройств настраиваются для совместной работы, что создает иллюзию одного роутера на узлах LAN, как показано на рисунке. При совместном использовании IP и MAC-адреса два или более роутеров могут работать как один виртуальный.

![](./assets/9.1.2.svg)


IPv4-адрес виртуального роутера настраивается в качестве шлюза по умолчанию для рабочих станций в отдельном сегменте IPv4. При отправке кадров с хост-устройств на шлюз по умолчанию хосты используют ARP для разрешения MAC-адреса, связанного с IPv4-адресом шлюза по умолчанию. С помощью протокола ARP определяется MAC-адрес виртуального роутера. После этого кадры, которые отправлены на его MAC-адрес, можно обработать физически с помощью текущего активного устройства в пределах группы виртуального. Протокол используется для определения двух или более роутеров в качестве устройств, отвечающих за обработку кадров, отправляемых на MAC или IP-адрес одного виртуального. Оконечные устройства отправляют трафик на адреса виртуального роутера. Физический же, который пересылает этот трафик, является прозрачным для оконечных устройств.

Протокол резервирования предоставляет механизм для определения роутера, который должен выполнять активную роль в пересылке трафика. Он также определяет, когда роль пересылки должна перейти к резервному устройству. Переход от одного пересылающего роутера к другому является прозрачным для конечных устройств.

Способность сети динамически восстанавливаться после сбоя устройства, выполняющего функцию шлюза по умолчанию, называется резервом на первом хопе.

<!-- 9.1.3 -->
## Действия при переключении в случае отказа роутера

В случае сбоя активного роутера протокол резервирования переводит резервный на новые функции активного. Происходит следующее:

1. резервный роутер перестает видеть сообщения приветствия от пересылающего устройства;
2. он принимает роль передающего роутера;
3. поскольку новый пересылающий роутера использует как IPv4, так и MAC-адрес виртуального, хост-устройства не замечают перебоев в обслуживании.

![](./assets/9.1.3.svg)


<!-- 9.1.4 -->
## Варианты FHRP

FSRP, используемая в производственной среде, в значительной степени зависит от оборудования и потребностей сети. В таблице перечислены все варианты, доступные для FHRP.

| **Варианты FHRP** | **Описание** |
| --- | --- |
| Протокол HSRP | HRSP является собственной разработкой Cisco-FHRP, которая предназначена для обеспечения прозрачного переключения на резервное устройство IPv4 первого перехода. Он обеспечивает высокую доступность сети за счет резервной маршрутизации первого перехода для IPv4-сетей, настроенных с IPv4-адресом шлюза по умолчанию. HSRP используется группой роутеров для выбора активного и резервного устройства. В группе интерфейсов устройств активным является то, которое нужно для маршрутизации пакетов. Резервное устройство берет работу на себя, когда активное выходит из строя или когда предварительно установленные условия сработали. Функция резервного роутера HSRP заключается в контроле работоспособного состояния группы HSRP и быстрого принятия роли переадресации пакетов в случае сбоя активного устройства. |
| HSRP для IPv6 | Патентованная Cisco-FHRP, которая обеспечивает ту же функциональность HSRP, но в среде IPv6. Группа HSRP IPv6 имеет виртуальный MAC-адрес, полученный из номера группы HSRP и виртуального канала IPv6, полученный из виртуального MAC-адреса HSRP. Периодические сообщения RA отправляются для локального адреса канала виртуальной IPv6 HSRP, когда группа HSRP активна. Когда группа становится неактивной, эти RA останавливаются после отправки последнего. |
| Протокол дополнительного резервирования виртуальных роутеров версии 2 (VRRPv2) | Открытый протокол выбора, динамически назначающий VRRP-устройствам ответственность за один или несколько виртуальных роутеров в IPv4-сети LAN. Таким образом, несколько устройств в канале с множественным доступом могут использовать один виртуальный IPv4-адрес. Роутер VRRP настроен для запуска VRRP в сочетании с одним или несколькими другими устроствами, подключенными к локальной сети. В конфигурации VRRP один из роутеров выбирается в качестве основного виртуального, а другие выступают в роли резервных на случай сбоя основного. |
| VRRPv3 | VRRPv3 предоставляет функции поддержки IPv4 и IPv6-адресов. VRRPv3 поддерживает адреса IPv4 и IPv6, работает в неоднородных средах и предоставляет более широкие возможности масштабирования, чем VRRPv2. |
| Протокол распределения нагрузки для шлюзов (GLBP) | Проприетарный протокол FHRP Cisco, который обеспечивает защиту трафика данных от неисправного роутера или сети (например, HSRP и VRRP), одновременно обеспечивая балансировку нагрузки (т.н. распределение нагрузки) по группе резервных устройств. |
| GLBP для IPv6 | Проприетарный протокол FHRP Cisco, который предоставляет те же функции GLBP, но для среды IPv6. GLBP для IPv6 обеспечивает автоматическое резервирование роутеров для узлов IPv6, настроенных с одним шлюзом по умолчанию в LAN. Несколько устройств первого перехода в LAN объединены в целях предоставления одного виртуального IPv6-роутера первого перехода при одновременном распределении нагрузки в процессе пересылки IPv6-пакетов. |
| Протокол обнаружения роутеров с использованием ICMP (IRDP) | Указанный в RFC 1256, IRDP является устаревшим решением FHRP. IRDP позволяет IPv4 определять местоположение устройств, обеспечивающих подключение по IPv4 к другим (нелокальным) IP-сетям. |

<!-- 9.1.5 -->
<!-- quiz -->
