<!-- 9.2.1 -->
## Общие сведения о протоколе HSRP

Cisco предоставляет HSRP и HSRP для IPv6 как способ избежать потери доступа к внешней сети в случае сбоя маршрутизатора по умолчанию.

Проприетарный протокол Cisco FHRP, предназначенный для обеспечения сквозного переключения IPv4-устройства первого перехода.

Протокол HSRP обеспечивает высокую доступность сети благодаря предоставлению функций обеспечения избыточности для маршрутизации на первом хопе для IPv4-узлов в сетях, настроенных с использованием IPv4-адреса шлюза по умолчанию. HSRP используется группой маршрутизаторов для выбора активного и резервного устройств. В рамках группы интерфейсов устройства активным называется устройство, используемое для маршрутизации пакетов; резервным — устройство, которое задействуется в случае сбоя активного устройства или при выполнении предварительно заданных условий. Задача резервного маршрутизатора HSRP заключается в мониторинге рабочего состояния группы HSRP и быстром переходе к выполнению функций пересылки пакетов в случае сбоя активного маршрутизатора.

<!-- 9.2.2 -->
## Приоритет и приоритетное вытеснение HSRP

Роль активных и резервных маршрутизаторов определяется во время процесса выбора HSRP. По умолчанию в качестве активного выбирается маршрутизатор с максимальным в численном отношении адресом IPv4. Однако всегда лучше контролировать, как сеть будет работать в нормальных условиях, чем оставлять это на волю случая.

**HSRP Priority**

Для определения активного маршрутизатора можно использовать приоритет HSRP. Маршрутизатор с наивысшим приоритетом HSRP станет активным маршрутизатором. По умолчанию приоритет HSRP равен 100. Если приоритеты равны, то в качестве активного выбирается маршрутизатор с максимальным в численном отношении адресом IPv4.

Чтобы настроить маршрутизатор в качестве активного, используйте команду интерфейса **standby priority**. Приоритеты HSRP имеют диапазон от 0 до 255.

**HSRP Preemption**

По умолчанию, после того как маршрутизатор становится активным, он остается таковым, даже если в сети появляется другой маршрутизатор с более высоким приоритетом HSRP.

Чтобы принудительно провести новый процесс выборов HSRP, когда маршрутизатор с более высоким приоритетом подключается в оперативный режим, необходимо включить параметр preemption с помощью команды **standby preempt** _interface_. Приоритетное вытеснение — это способность маршрутизатора HSRP запускать процесс повторного выбора. Если приоритетное вытеснение включено, то при появлении в сети маршрутизатора с более высоким приоритетом HSRP он становится активным маршрутизатором.

Приоритетное вытеснение позволяет маршрутизатору стать активным, только если у него более высокий приоритет. Если у маршрутизатора такой же приоритет, но больший адрес IPv4, он не будет вытеснять действующий активный маршрутизатор. См. топологию на рисунке.

![](./assets/9.2.2.svg)


Маршрутизатор R1 имеет приоритет HSRP, равный 150, а маршрутизатор R2 имеет приоритет HSRP по умолчанию, равный 100. На маршрутизаторе R1 включено приоритетное вытеснение. Благодаря большему приоритету маршрутизатор R1 является активным, а маршрутизатор R2 — резервным.  В результате сбоя питания, который коснулся только R1, активный маршрутизатор становится недоступным и резервный маршрутизатор R2 принимает роль активного маршрутизатора. После восстановления питания R1 возвращается в сеть. Поскольку R1 имеет более высокий приоритет и включено приоритетное вытеснение, будет запущен новый процесс выбора. R1 снова принимает роль активного маршрутизатора, а R2 возвращает себе роль резервного маршрутизатора.

**Примечание**: Если приоритетное вытеснение отключено, то активным маршрутизатором становится первый загруженный маршрутизатор, если во время процесса выбора в сети нет других маршрутизаторов.

<!-- 9.2.3 -->
## Состояния и таймеры HSRP

Маршрутизатор может быть либо активным маршрутизатором HSRP, который отвечает за пересылку трафика для сегмента, либо пассивным маршрутизатором HSRP в резерве, который готов принять на себя активную роль в случае сбоя активного маршрутизатора. Если на интерфейсе включен HSRP или интерфейс впервые активируется в существующей конфигурации HSRP, то маршрутизатор отправляет и получает пакеты приветствия HSRP, чтобы начать процесс определения того, какое состояние в группе HSRP он примет.

В таблице приведена сводная информация по состояниям HSRP.

| Состояния HSRP | Описание |
| --- | --- |
| Initial (начальное) | Это состояние возникает при изменении конфигурации или в том случае, когда интерфейс впервые становится доступным. |
| Learn (Получение информации) | Маршрутизатор не определил виртуальный IP-адрес и пока не получил сообщение приветствия от активного маршрутизатора. В этом состоянии маршрутизатор ожидает получения сообщения приветствия от активного маршрутизатора. |
| Listen (прослушивание) | Маршрутизатору известен виртуальный IP-адрес, но маршрутизатор не является ни активным, ни резервным маршрутизатором. Он прослушивает сообщения приветствия от этих маршрутизаторов. |
| Speak (приветствие) | Маршрутизатор периодически отправляет сообщения приветствия и активно участвует в выборах активного и (или) резервного маршрутизатора. |
| Standby (Резервный) | Маршрутизатор является кандидатом на роль следующего активного маршрутизатора и периодически отправляет сообщения приветствия. |

По умолчанию активные и резервные маршрутизаторы HSRP отправляют пакеты приветствия на групповой адрес группы HSRP каждые 3 секунды. Резервный маршрутизатор станет активным, если он не получает сообщения приветствия от активного маршрутизатора в течение 10 секунд. Эти настройки таймера можно уменьшить, чтобы ускорить переключение при отказе или приоритетное вытеснение. Однако чтобы избежать повышения нагрузки на ЦП и ненужных изменений резервного состояния, не устанавливайте таймер приветствия менее, чем на 1 секунду, а таймер удержания — менее, чем на 4 секунды.

<!-- 9.2.4 -->
<!-- quiz -->