# Назначение протокола STP

<!-- 5.1.1 -->
## Резервирование в коммутируемых сетях уровня 2

В этом разделе рассматриваются причины возникновения петель в коммутируемых сетях и кратко описывается, как работает протокол связующего дерева. Резервирование является важной частью иерархической модели, предотвращающей перебои в оказании сетевых сервисов пользователям. Для сетей с резервированием требуется добавление физических путей, но необходимо также предусмотреть и логическое резервирование. Наличие альтернативных физических каналов для передачи данных по сети позволяет пользователям получить доступ к сетевым ресурсам даже в случае сбоя одного из каналов. Тем не менее избыточные маршруты в коммутируемой сети Ethernet могут привести к возникновению физических и логических петель 2-го уровня.

Для локальных сетей Ethernet требуется топология без петель с одним путем между любыми двумя устройствами. Петля в локальной сети Ethernet может вызывать постоянное распространения кадров Ethernet до тех пор, пока соединение не будет разорвано и это не ликвидирует петлю.

<!-- 5.1.2 -->
## Протокол STP

Протокол связующего дерева (STP) - это сетевой протокол предотвращения петель, который обеспечивает избыточность при создании топологии уровня 2 без петель. IEEE 802.1D является исходным стандартом IEEE MAC соединения мостов для STP.

### STP Normal Operation

![](./assets/5.1.2.gif)

<!-- 5.1.3 -->
## Перестройка STP

### STP Compensates for Network Failure

Рисунок представляет собой анимацию с той же топологией, что и в предыдущей анимации. На рисунке, видно что произошел сбой в работе транкового канала между S1 и S2. S2 разблокирует порт для Trunk2. Компьютер PC1 отправляет широковещательный кадр на S2. S2 пересылает его из всех портов, за исключением порта источника и неисправного канала для Trunk1. S3 пересылает его из всех доступных портов, за исключением порта источника. S1 передает его только из F0/3.

![](./assets/5.1.3.gif)

<!-- 5.1.4 -->
## Проблемы с избыточными каналами коммутатора

Резервирование путей обеспечивает необходимую доступность множества сетевых сервисов, устраняя вероятность перебоев в работе всех сетевых служб в случае отказа в отдельной точке. При наличии нескольких путей между двумя устройствами и отсутствии реализации протокола spanning-tree возникает петля 2-го уровня. Петли уровня 2 могут привести к нестабильности таблицы MAC-адресов, перегрузке каналов и высокой загрузке ЦП на коммутаторах и конечных устройствах, в результате чего сеть становится непригодной для использования.

В отличие от протоколов уровня 3, IPv4 и IPv6, уровень 2 Ethernet не включает в себя механизм распознавания и устранения бесконечно зацикливающихся кадров. Некоторые протоколы 3-го уровня используют механизмы времени жизни (TTL), которые ограничивают количество попыток повторной передачи пакетов сетевыми устройствами 3-го уровня. Маршрутизатор уменьшит TTL (Time to Live) в каждом пакете IPv4 и поле Hop Limit в каждом пакете IPv6. Когда эти поля уменьшатся до 0, маршрутизатор отбрасывает пакет. Коммутаторы Ethernet и Ethernet не имеют сопоставимого механизма ограничения числа раз, когда коммутатор передает кадр уровня 2. STP был разработан специально в качестве механизма предотвращения петли для Ethernet уровня 2.

<!-- 5.1.5 -->
## Петли 2-го уровня
Без включения STP петли уровня 2 могут формироваться, что приводит к бесконечному циклу широковещательных, многоадресных и неизвестных одноадресных кадров. Это может привести к разрушению сети в течение очень короткого промежутка времени, иногда всего за несколько секунд. Например, широковещательные кадры, такие как запрос ARP, перенаправляются на все порты коммутатора, кроме исходного входного порта. Это гарантирует, что все устройства в домене широковещательной рассылки могут получить кадр. При наличии более одного пути, из которого пересылается кадр, может возникнуть бесконечная петля. При появлении петли возникает возможность постоянного изменения таблицы MAC-адресов на коммутаторе обновлениями из кадров широковещательной рассылки, что приводит к нестабильности базы данных MAC-адресов. Это может привести к высокой загрузке ЦП, что приводит коммутатор в не рабочее состоянии.

Кадры широковещательной рассылки являются не единственным типом кадров, на которые влияет возникновение петель. Неизвестные одноадресные кадры, отправленные в циклическую сеть, могут приводить к появлению дублирующихся кадров, поступающих на целевое устройство. Неизвестный одноадресный кадр с коммутатора формируется, когда у коммутатора нет MAC-адреса назначения в таблице MAC-адресов, и он должен переслать этот кадр со всех своих портов, за исключением входного порта.

![](./assets/5.1.5.gif)

<!-- 5.1.6 -->
## Широковещательный шторм

Широковещательный шторм - это ненормально большое количество широковещательных передач, подавляющих сеть в течение определенного периода времени. Широковещательные штормы могут отключить сеть за считанные секунды, перегружая коммутаторы и конечные устройства. Широковещательные штормы могут быть вызваны аппаратными проблемами, такими как неисправный сетевой адаптер или петля 2-го уровня в сети.

Широковещательные рассылки уровня 2 в сети, такие как ARP-запросы, очень распространены. Петля Уровня 2, вероятно, будет иметь немедленные и разрушительные последствия в сети. Многоадресные рассылки второго уровня обычно пересылаются так же, как и широковещательные рассылки коммутатором. Таким образом, хотя пакеты IPv6 никогда не пересылаются как широковещательная передача уровня 2, ICMPv6 Neighbor Discovery использует многоадресную рассылку уровня 2.

Анимация демонстрирует все более неблагоприятные последствия петли, поскольку широковещательные и неизвестные кадры одноадресной передачи продолжают распространяться в течение широковещательного шторма.

![](./assets/5.1.6.gif)

Узел, участвующий в сетевой петле, недоступен для других узлов в сети. Кроме того, вследствие постоянных изменений в таблице MAC-адресов коммутатор не знает, из какого порта следует пересылать кадры одноадресной рассылки. В вышеуказанном примере для PC1 перечислены неправильные порты. Любой одноадресный кадр, предназначенный для PC1, пересылается в сети по петле, подобно широковещательным кадрам. Из-за возрастающего числа кадров, формирующих петлю в сети, в конечном итоге образуется широковещательный шторм.

Во избежание подобных проблем в сети с избыточностью, на коммутаторах должны быть включены определённые типы протокола spanning-tree. Протокол spanning-tree по умолчанию включено на коммутаторах Cisco, предотвращая, таким образом, возникновение петель 2-го уровня.

<!-- 5.1.7 -->
## Алгоритм связующего дерева

Протокол STP основан на алгоритме, изобретенном Радией Перлман (Radia Perlman) во время ее работы в Digital Equipment Corporation и опубликованном в статье 1985 г. «Алгоритм распределенного вычисления протокола связующего дерева в расширенной сети LAN» (An Algorithm for Distributed Computation of a Spanning Tree in an Extended LAN). Ее алгоритм связующего дерева (STA) создает топологию без петли, выбрав один корневой мост, где все остальные коммутаторы определяют один путь с наименьшей стоимостью.

Без протокола предотвращения петель возникли бы петли, делающие избыточную коммутируемую сеть неработоспособной.

### Сценарий топологии STA

В этом сценарии STA используется сеть Ethernet с избыточными соединениями между несколькими коммутаторами.

![](./assets/5.1.7-1.PNG)
<!-- /courses/srwe-dl/af9ece92-34fe-11eb-b1b2-9b1b0c1f7e0d/afb62728-34fe-11eb-b1b2-9b1b0c1f7e0d/assets/c9cdc731-1c27-11ea-af09-3b2e6521927c.svg -->

Топология физической сети показывает восемь взаимосвязанных коммутаторов. Коммутатор S1 подключается к коммутаторам S2, S3 и S5. Коммутатор S2 подключается к коммутаторам S1 и S4. Коммутатор S3 подключается к коммутаторам S1 и S5. Коммутатор S4 подключается к коммутаторам S2 и S5. Коммутатор S5 подключается к коммутаторам S1, S3, S4 и S6. Коммутатор S6 подключается к коммутатору S5. Коммутатор S7 подключается к коммутатору S8. Коммутатор S8 подключается к коммутаторам S4, S5 и S7.

### Выберите корневой мост

Алгоритм связующего дерева начинается с выбора одного корневого моста. На рисунке показано, что коммутатор S1 был выбран в качестве корневого моста. В этой топологии все каналы имеют одинаковую стоимость (та же пропускная способность). Каждый коммутатор определяет один путь с наименьшей стоимостью от себя до корневого моста.

**Примечание:** STA и STP называют коммутаторы - мостами. Это связано с тем, что в первые дни Ethernet коммутаторы назывались мостами.

![](./assets/5.1.7-2.PNG)
<!-- /courses/srwe-dl/af9ece92-34fe-11eb-b1b2-9b1b0c1f7e0d/afb62728-34fe-11eb-b1b2-9b1b0c1f7e0d/assets/c9ce1552-1c27-11ea-af09-3b2e6521927c.svg -->

Топология физической сети показывает восемь взаимосвязанных коммутаторов. Коммутатор S1 является корневым мостом и подключается к коммутаторам S2, S3 и S5. Коммутатор S2 подключается к коммутаторам S1 и S4. Стрелка показывает лучший путь от S2 к S1. Коммутатор S3 подключается к коммутаторам S1 и S5. Стрелка показывает, что лучший путь от S3 к S1. Коммутатор S4 подключается к коммутаторам S2 и S5. Стрелка показывает, что лучший путь от S4 к S2. Коммутатор S5 подключается к коммутаторам S1, S3, S4 и S6. Стрелка показывает, что лучший путь от S5 к S1. Коммутатор S6 подключается к коммутатору S5. Стрелка показывает, что лучший путь от S6 к S5. Коммутатор S7 подключается к коммутатору S8. Стрелка показывает, что лучший путь от S7 к S8. Коммутатор S8 подключается к коммутаторам S4, S5 и S7. Стрелка показывает, что лучший путь от S8 к S5.

### Блокирование избыточных путей

Протокол STP обеспечивает наличие только одного логического пути между всеми узлами назначения в сети путем намеренного блокирования резервных путей, которые могли бы вызвать петлю. Порт считается заблокированным, когда заблокирована отправка и прием данных на этот порт. Для предотвращения петель в сети чрезвычайно важно блокировать резервные пути.

![](./assets/5.1.7-3.PNG)
<!-- /courses/srwe-dl/af9ece92-34fe-11eb-b1b2-9b1b0c1f7e0d/afb62728-34fe-11eb-b1b2-9b1b0c1f7e0d/assets/c9ce8a82-1c27-11ea-af09-3b2e6521927c.svg -->

Коммутаторы S4, S5 и S8 заблокировали избыточные пути к корневому мосту.

Топология физической сети показывает восемь взаимосвязанных коммутаторов. Коммутатор S1 является корневым мостом и подключается к коммутаторам S2, S3 и S5. Коммутатор S2 подключается к коммутаторам S1 и S4. Стрелка показывает лучший путь от S2 к S1. Коммутатор S3 подключается к коммутаторам S1 и S5. Стрелка показывает, что лучший путь от S3 к S1. Коммутатор S4 подключается к коммутаторам S2 и S5. Стрелка показывает, что лучший путь от S4 к S2, а порт коммутатора к S5 является заблокированным портом. Коммутатор S5 подключается к коммутаторам S1, S3, S4 и S6, а порт коммутатора S3 является заблокированным портом. Стрелка показывает, что лучший путь от S5 к S1. Коммутатор S6 подключается к коммутатору S5. Стрелка показывает, что лучший путь от S6 к S5. Коммутатор S7 подключается к коммутатору S8. Стрелка показывает, что лучший путь от S7 к S8. Коммутатор S8 подключается к коммутаторам S4, S5 и S7. Стрелка показывает, что лучший путь от S8 к S5, а порт коммутатора к S4 является заблокированным портом. Текст в нижней части рисунка гласит Коммутаторы S4, S5 и S8 заблокировали избыточные пути к корневому мосту.

### Топология без петель

Заблокированный порт приводит к тому, что эта ссылка не пересылает между двумя коммутаторами, как показано на рисунке. Обратите внимание, что это создает топологию, в которой каждый коммутатор имеет только один путь к корневому мосту, аналогично ветвям дерева, которые подключаются к корню дерева.

![](./assets/5.1.7-4.PNG)
<!-- /courses/srwe-dl/af9ece92-34fe-11eb-b1b2-9b1b0c1f7e0d/afb62728-34fe-11eb-b1b2-9b1b0c1f7e0d/assets/c9cf74e1-1c27-11ea-af09-3b2e6521927c.svg -->

Теперь у каждого коммутатора есть только один путь пересылки данных к корневому мосту.

Топология физической сети показывает восемь взаимосвязанных коммутаторов. Коммутатор S1 является корневым мостом и подключается к коммутаторам S2, S3 и S5. Коммутатор S2 подключается к коммутаторам S1 и S4. Коммутатор S3 подключается к коммутаторам S1 и S5. Коммутатор S4 подключается к коммутаторам S2 и S5. Порт коммутатора S5 является заблокированным портом. Коммутатор S5 подключается к коммутаторам S1, S3, S4 и S6, а порт коммутатора S3 является заблокированным портом. Коммутатор S6 подключается к коммутатору S5. Коммутатор S7 подключается к коммутатору S8. Коммутатор S8 подключается к коммутаторам S4, S5 и S7. Порт коммутатора S4 является заблокированным портом. Текст в нижней части рисунка гласит Каждый коммутатор имеет только один путь пересылки к корневому мосту.

### Сбой связи вызывает перерасчет

Физические пути по-прежнему используются для обеспечения избыточности, однако эти пути отключены в целях предотвращения петель. Если путь потребуется для компенсации неисправности сетевого кабеля или коммутатора, протокол STP повторно рассчитывает пути и снимает блокировку с требуемых портов, чтобы разрешить активацию избыточного пути. Перерасчет STP также могут происходить в любой момент, когда новый коммутатор или новый межкоммутационный канал добавляется в сеть.

На рисунке показан сбой канала между коммутаторами S2 и S4, который приводит к перерасчету STP. Обратите внимание, что ранее избыточный канал между S4 и S5 теперь перенаправляется для компенсации этого сбоя. Между каждым коммутатором и корневым мостом остается только один путь.

![](./assets/5.1.7-5.PNG)
<!-- /courses/srwe-dl/af9ece92-34fe-11eb-b1b2-9b1b0c1f7e0d/afb62728-34fe-11eb-b1b2-9b1b0c1f7e0d/assets/c9d01120-1c27-11ea-af09-3b2e6521927c.svg -->

Топология физической сети показывает восемь взаимосвязанных коммутаторов. Коммутатор S1 является корневым мостом и подключается к коммутаторам S2, S3 и S5. Коммутатор S2 подключается к коммутаторам S1 и S4. Канал с S4 отображается красным цветом X. Коммутатор S3 подключается к коммутаторам S1 и S5. Коммутатор S4 подключается к коммутаторам S2 и S5. Порт коммутатора S5 обозначается как порт для птиц. Коммутатор S5 подключается к коммутаторам S1, S3, S4 и S6, а порт коммутатора S3 является заблокированным портом. Коммутатор S6 подключается к коммутатору S5. Коммутатор S7 подключается к коммутатору S8. Коммутатор S8 подключается к коммутаторам S4, S5 и S7. Порт коммутатора S4 является заблокированным портом.

Протокол STP предотвращает возникновение петель за счет настройки беспетлевого пути в сети с использованием портов, стратегически настроенных на заблокированное состояние. Коммутаторы, использующие протокол STP, могут компенсировать сбои за счет динамической разблокировки ранее блокированных портов и разрешения передачи трафика по альтернативным путям.

<!-- 5.1.8 -->
## Видео - Наблюдение за работой STP

Нажмите кнопку Воспроизведение для отображения протокола STP.

<video width="768" height="432" controls>
  <source src="https://github.com/nsalab-tmn/learn-ccna2/raw/main/5.1-purpose-of-stp/assets/5.1.8.mp4" type='video/mp4; codecs="avc1.42E01E, mp4a.40.2"'>
</video>

<!-- 5.1.9 -->
## Packet Tracer - изучение работы STP для предотвращения петли

В рамках данного упражнения Packet Tracer необходимо решить следующие задачи.

- Создайте и настройте простую сеть с тремя коммутаторами с STP.
- Обзор работы протокола STP
- Отключите STP и снова просмотрите работу сети.

[Открыть описание в PDF](./assets/5.1.9-packet-tracer---investigate-stp-loop-prevention_ru-RU.pd)

[Скачать файл для Packet Tracer](./assets/5.1.9-packet-tracer---investigate-stp-loop-prevention_ru-RU.pka)

<!-- 5.1.10 Проверьте свое понимание темы - Задачи STP quiz -->
